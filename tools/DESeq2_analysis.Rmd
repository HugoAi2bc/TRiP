---
title: "Analyse DEseq2"
author: "LES GST"
date: "`r format (Sys.time(), '%B %d, %Y')`"
output: "html_document"
params:
    refCond: "W1_RIBOSEQ"
    logFC: 0
    pval: 0.01
---

#Sys.getenv("RSTUDIO_PANDOC")
Sys.setenv(RSTUDIO_PANDOC="/root/miniconda3/envs/all_TRiP/bin/pandoc")

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(include = TRUE, message = FALSE, warning = FALSE)
#knitr::opts_chunk$set(root.dir = "/data/")
#knitr::opts_knit$set(root.dir = paste0("/data/RESULTS/DESeq2/"))
```


```{r rm Global environment, include=FALSE}
rm(list=ls())
```


```{r packages}
library(DESeq2)
library(stringr)
```


```{r Arguments, include=FALSE}
#args = commandArgs(trailingOnly=TRUE)

#if (is.na(args[1])) {args[1] <- "CT"}
#if (is.na(args[2])) {args[2] <- 0}
#if (is.na(args[3])) {args[3] <- 0.01}

#writeLines(args[1], "/data/TEST_ARGS1.txt")
#writeLines(params$refCond, "/data/TEST_ARGS1.txt")

#Var_log2FC <- as.numeric(args[2])
#Var_padj <- as.numeric(args[3])
CT = "W1_RIBOSEQ"
Var_log2FC <- 0
Var_padj <- 0.01
#Var_log2FC <- as.numeric(params$logFC)
#Var_padj <- as.numeric(params$pval)
```
\

#### Lecture des donnees
```{r data , echo=FALSE}
expData = read.table("/data/RESULTS/DESeq2/count_matrix.txt", header = T, row.names = 1)
```
##### *`/data/count_matrix_R2.txt`*
\

####  Visualisation donnees brutes
```{r  results = 'asis', echo = FALSE}

knitr::kable(head(expData[1:6,]))
```

```{r Determination du nombre des echantillons , include=FALSE }
expData_Sorted <- expData[,sort(colnames(expData))]
Names_Col <- colnames(expData_Sorted)
Cond <- str_replace(Names_Col,regex("[[:digit:]]{1,}$"),"")
nb_col_condA <- table(factor(Cond))[[1]]
nb_col_condB <- table(factor(Cond))[[2]]


#if (Cond[1] != args[1]) {
if (Cond[1] != CT) {
#if (Cond[1] != params$refCond) {
        Ord <- c( (1:nb_col_condB)+nb_col_condA , (1:nb_col_condA) )
        expData_Sorted <- expData_Sorted[, Ord]

# inversion des 2 valeurs nb_col_condA et B sans passer par une 3eme variable
        nb_col_condA <- nb_col_condA + nb_col_condB
        nb_col_condB <- nb_col_condA - nb_col_condB
        nb_col_condA <- nb_col_condA - nb_col_condB
}
```
##### *`r paste0("Samples : ",nb_col_condB," ",Cond[nb_col_condB+1]," vs ",nb_col_condA," ",Cond[1])`*
 \
 \




#### Comparaison des tailles des librairies
```{r Library sizes, fig.height = 3, fig.width = 4}
barplot(colSums(expData_Sorted), ylab = "Total read number",
        main = "Library sizes", col = c(rep("yellow", nb_col_condA), rep("blue", nb_col_condB)),
        names = colnames(expData_Sorted),
        cex.names = 0.6
        )
```
\

#### Normalisation avec DEseq2.
```{r}
conds    = factor(c(rep("CondA", nb_col_condA), rep("CondB", nb_col_condB)))
colData  = data.frame(condition = conds)
ddsObjet = DESeqDataSetFromMatrix(countData = expData_Sorted,
                                  colData   = colData, formula(~ condition))
ddsObjet = estimateSizeFactors(ddsObjet)
Size_Factors <- sizeFactors(ddsObjet)
# Donnees de comptage normalisÃ©es :
normCountData = counts(ddsObjet, normalized = TRUE)
```
\

#### Comparaison des tailles des librairies (apres normalisation)
```{r , fig.height = 3, fig.width = 4}
barplot(colSums(normCountData), ylab = "Total read number",
        main = "Library sizes (after normalization)",
        col = c(rep("yellow", nb_col_condA), rep("blue", nb_col_condB)),
        names = colnames(expData_Sorted),
        cex.names = 0.6)
```
\

#### Boxplot des tailles des librairies.
```{r Boxplot}
row_sub_1 = apply(expData_Sorted, 1, function(row) all(row != 0 ))
row_sub_2 = apply(normCountData, 1, function(row) all(row != 0 ))
par(mfrow = c(1,2))

boxplot((expData_Sorted[row_sub_1,]),
        #ylab = "Total read number",
        main = "Library sizes",
        log = "y",
        col = c(rep("yellow", nb_col_condA), rep("blue", nb_col_condB)),
        names = colnames(expData_Sorted),
        cex.names = 0.6,
        las =2
        ,ylim = c(1,max(expData_Sorted[,]) )
        )
boxplot((normCountData[row_sub_2,]), ylab = "Total read number",
        main = "Library sizes (after normalization)",
        log = "y",
        col = c(rep("yellow", nb_col_condA), rep("blue", nb_col_condB)),
        names = colnames(expData_Sorted),
        cex.names = 0.6,
        las =2,
        yaxt = "n",
        ylim = c(1,max(expData_Sorted[,]) ))
```


```{r annulation de pagination graphe, include = FALSE}
par(mfrow = c(1,1))
```
\

#### Pairwise scatter plot
```{r pairwiseScatter, echo = FALSE}
pairs(expData_Sorted[,1:4], pch = 19, cex = 0.1)
```



```{r , include = FALSE}
# La valeur +1 est ajoutÃ Ã  tous les gÃ¨nes, pour toutes les conditions,
# afin d'Ã©viter les Ã©ventuelles divisions par 0.
normCountData = normCountData + 1

# Moyenne du contrÃ´le
CT_Mean<- data.frame(apply(normCountData[,1:(nb_col_condA)],1,mean))
Mut_Mean<- data.frame(apply(normCountData[,(nb_col_condA+1):dim(normCountData)[2]],1,mean))
#Mut_Mean<- data.frame(apply(normCountData[,(nb_col_condA+1):(nb_col_condB)],1,mean))

logFC = log2(Mut_Mean / CT_Mean)
colnames(logFC) = paste("logFC")
```
\

#### Histogramme Frequence / LogFC
```{r , include = TRUE}

vec_logFC <- as.vector(t(logFC))
hist(vec_logFC,
     nclass = 200,
     xlab = "logFC values",
     main ="Histogramme Frequence / LogFC" )
abline(v = 2, col = "red")
abline(v = -2, col = "red")
```
\


```{r, include=FALSE}
#### L'Ecart type des logFC pour chaque gene
#sdLogFC = apply(logFC, 1, sd)
#plot(sdLogFC, meanLogFC, pch = 20)
#abline(h = 2, col = "red")
#abline(h = -2, col = "red")
```
\


```{r, include = FALSE}
#### L'histogramme de  TValue
#tVal = meanLogFC / (sdLogFC/sqrt(3))
#hist(tVal, nclass = 100, xlab = "T values")
```

```{r mean,  include=FALSE}
meanExp = apply(normCountData, 1, mean)
```
\

#### Application du package DESeq2, pour le calcul des statistiques
```{r, include = FALSE}
ddsEstim = DESeq(ddsObjet)
resDESeq = results(ddsEstim, contrast = c("condition", "CondA", "CondB"))
```
\

#### MA plot
```{r, include=FALSE}
mcols(resDESeq, use.names = TRUE)
dds = estimateDispersions(ddsObjet)
```

```{r, include=TRUE}
plotMA(resDESeq)


plotDispEsts(dds)
```
\

#### l'histogramme des pvalues
```{r }
hist(resDESeq[,"pvalue"], nclass = 100, xlab = "p-value",
     main = "p-values (DESeq2)")
```
\

#### l'histogramme des pvalues ajustees
```{r }
hist(resDESeq[,"padj"], nclass = 100, xlab = "padj",
     main = "Adjusted p-values (DESeq2)")
```
\

#### Volcano plot
```{r, volcano plot global}
myColors <- ifelse((resDESeq$padj < Var_padj & resDESeq$log2FoldChange > Var_log2FC), "green" ,
                   ifelse((resDESeq$padj < Var_padj & resDESeq$log2FoldChange < Var_log2FC), "red" ,
                          "black" ) )

plot(resDESeq[, "log2FoldChange"], -log10(resDESeq[, "padj"]),
     pch = 20, cex = 1,
     col=myColors,
     xlab = "log2 FC", ylab = "-log10(padj)",
     main = paste0("Volcano plot - ",Cond[nb_col_condB+1]," vs ",Cond[1])
     )
```
\

#### Volcano plot (zoom)
```{r, volcano plot zoom}
myColors <- ifelse((resDESeq$padj < params$pval & resDESeq$log2FoldChange > params$logFC), "green" ,
                   ifelse((resDESeq$padj < params$pval & resDESeq$log2FoldChange < params$logFC), "red" ,
                          "black" ) )

Valeurs_Limite_Y <- ifelse((resDESeq$padj < params$pval & resDESeq$log2FoldChange > params$logFC), params$pval ,
               ifelse((resDESeq$padj < params$pval & resDESeq$log2FoldChange < params$logFC), params$pval ,
               resDESeq$padj) )

Forme_Pixel_Y <- ifelse((resDESeq$padj < params$pval & resDESeq$log2FoldChange > params$logFC), 17 ,
                           ifelse((resDESeq$padj < params$pval & resDESeq$log2FoldChange < params$logFC), 17 ,
                                  20) )



plot(resDESeq[, "log2FoldChange"], -log10(Valeurs_Limite_Y),
     pch = Forme_Pixel_Y,
     col=myColors,
     xlab = "log2 FC", ylab = "-log10(padj)",
     ylim = c(0,2),

     main = paste0("Volcano plot - ",Cond[nb_col_condB+1]," vs ",Cond[1])


     )
```
\

```{r Creation Tables finales, include = FALSE}
Bruts_Norm <- cbind(expData_Sorted, normCountData )

Table_Complete <- data.frame(cbind(row.names(Bruts_Norm) , Bruts_Norm, CT_Mean,Mut_Mean , resDESeq) )
colnames(Table_Complete) = col.names = c("genes" ,
                               paste("CT", 1:nb_col_condA, sep = "_"),
                               paste("Mut", 1:nb_col_condB, sep = "_"),
                               paste("norm.CT", 1:nb_col_condA, sep = "_"),
                               paste("norm.Mut", 1:nb_col_condB, sep = "_"),
                               "CT_Mean", "Mut_Mean",
                               colnames(resDESeq))


inducedGenes = Table_Complete[which((Table_Complete[, "log2FoldChange"] > Var_log2FC) & (Table_Complete[, "padj"] < Var_padj)),]
dim(inducedGenes)

repressedGenes = Table_Complete[which((Table_Complete[, "log2FoldChange"] < -Var_log2FC) & (Table_Complete[, "padj"] < Var_padj)),]
dim(repressedGenes)

# Tri des tables par padj
inducedGenes <- inducedGenes[(order(inducedGenes[,"padj"])),]
repressedGenes <- repressedGenes[(order(repressedGenes[,"padj"])),]



```



#### Ecriture des resultats
```{r, include= FALSE}
write.table(Table_Complete,
            file = paste0("/data/RESULTS/DESeq2/complete.txt"),
            quote = F, sep = "\t", row.names = F)


write.table(inducedGenes,
            file = paste0("/data/RESULTS/DESeq2/up.txt"),
            quote = F, sep = "\t", row.names = F)

write.table(repressedGenes,
            file = paste0("/data/RESULTS/DESeq2/down.txt"),
            quote = F, sep = "\t", row.names = F)

```



`r paste0("/data/RESULTS/DESeq2/complete.txt")`
\
`r paste0("/data/RESULTS/DESeq2/up.txt")  `
\
`r paste0("/data/RESULTS/DESeq2/down.txt")  `
